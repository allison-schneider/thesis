%% This is an example first chapter.  You should put chapter/appendix that you
%% write into a separate file, and add a line \include{yourfilename} to
%% main.tex, where `yourfilename.tex' is the name of the chapter/appendix file.
%% You can process specific files by typing their names in at the 
%% \files=
%% prompt when you run the file main.tex through LaTeX.
\chapter{Methods}

Two trajectory calculation routines, a kinematic and a dynamic model, were written using Python's NumPy scientific computing package.
Both routines numerically predict the trajectories of an ensemble of parcels by determining the velocities of parcels over time. 
The kinematic routine finds these velocities by interpolating between grids of wind speed data. 
The dynamic routine calculates velocities using advection equations relating the parcel acceleration and the geopotential height of a given pressure level. 

\section{Ten Day Dataset}
Data from the Global Forecast System (GFS), a weather forecast model produced by the National Centers for Environmental Protection (NCEP), was used for both models.
The dataset chosen was a ten day forecast, starting at 12:00:00 on February 21st, 2017, with predictions at intervals of three hours.
Each file in the dataset contains atmospheric predictions for the beginning of a three-hour interval. 
The values of atmospheric variables are predicted at each point on a latitude-longitude grid spanning the globe, with a spacing between gridpoints of 0.25 degree.
Values are predicted for East-West and North-South wind speed components $u$ and $v$, as well as the geopotential height $Z_g$ of the 250 millibar pressure level.

\section{Linear Interpolation}
Both the kinematic and dynamic models require an interpolation scheme to produce values for atmospheric variables in between the gridded values provided by GFS. 
Linear interpolation is the standard choice for trajectory models \cite{bowman_input_2013}. 
For both models, linear interpolation was used in three dimensions (latitude, longitude, and time). 
In the kinematic model, $u$ and $v$ components of wind speed were interpolated, while in the dynamic model, geopotential height was interpolated.

\section{Second-order Integration Scheme}
The numerical scheme chosen was a second-order Runge-Kutta method with a long track record in trajectory modeling \cite{petterssen_weather_1940}.
The velocity at a given timestep is taken to be the average of the velocity at the initial position and the velocity at the first-guess position after one timestep.

The first guess position $\vec{P}' (t + \Delta t)$ is 
\begin{align}
\vec{P}' (t + \Delta t) = \vec{P}(t) + \vec{V} (\vec{P}, t) \Delta t
\end{align}

and the final position $\vec{P} (t + \Delta t)$ is
\begin{align}
\vec{P} (t + \Delta t) = \vec{P} (t) + \frac{1}{2} \left [ \vec{V} (\vec{P}, t) + \vec{V} (\vec{P'}, t + \Delta t) \right ] \Delta t
\end{align}

where $\vec{P}$ is a position vector with latitude and longitude components, and $\vec{V}$ a velocity vector with $u$ and $v$ wind speeds \cite{draxler_description_1997}.
This integration method is used by HYSPLIT and a number of other trajectory models, including FLEXPART, LAGRANTO, and STILT \cite{stein_noaas_2015} \cite{bowman_input_2013}. 
For trajectories calculated from interpolated gridded wind velocities, higher order integration schemes do not add precision \cite{draxler_description_1997}.  

\section{Constant Timestep}
The timestep for integration was three minutes, with the timestep throughout the trajectory. 
To save computation, HYSPLIT uses a dynamic timestep, varying from one minute to one hour, computed to satisfy

\begin{align}
U_{max} [\text{grid-units min}^{-1}] \Delta t [\text{min}] < 0.75 [\text{grid-units}] 
\end{align}

\cite{draxler_description_1997}. This ensures that the parcel does not blow past any grid squares during a single timestep, which maximizes the accuracy of the calculation. 
%Check my trajectories to see if the U_max dt < 0.75 relation is always satisfied. If it isn't, consider reducing the timestep.

\section{Kinematic Equations}
At each timestep, after $u$ and $v$ speeds were interpolated and an average value found using the integration scheme, the kinematic model used two equations to solve for a parcel's displacement. 
Since the gridded $u$ and $v$ values are given in meters per second, the equations convert from Cartesian to geographic coordinates. 
The $r$ value of a parcel is taken to be the radius of the Earth $R_E$ plus the parcel's geopotential height $Z_g$.

\begin{align}
r &= R_E + Z_g \\
\frac{d \varphi}{dt} &= \frac{v}{r} \\
\frac{d \lambda}{dt} &= \frac{u}{r \cos{\varphi}}
\end{align}

\section{Dynamic Equations}
In the dynamic model, velocity at the next timestep was calculated using two more differential equations, using the current geopotential height gradient and the previous timestep's $u$ and $v$ values.
The Coriolis parameter $f$ measures the effect of the Earth's rotation speed $\Omega$ at a given latitude $\varphi$.
Standard acceleration due to gravity is $g$. 

\begin{align}
f &= 2 \Omega \sin{\varphi} \\
\frac{du}{dt} &= g \frac{\partial Z_g}{\partial \lambda} + fv \\
\frac{dv}{dt} &= g \frac{\partial Z_g}{\partial \varphi} - fu
\end{align}