%% This is an example first chapter.  You should put chapter/appendix that you
%% write into a separate file, and add a line \include{yourfilename} to
%% main.tex, where `yourfilename.tex' is the name of the chapter/appendix file.
%% You can process specific files by typing their names in at the 
%% \files=
%% prompt when you run the file main.tex through LaTeX.
\chapter{Methods}

Two trajectory calculation routines, a kinematic and a dynamic model, were written using Python's NumPy scientific computing package.
Both routines numerically predict the trajectories of an ensemble of parcels by determining the velocities of parcels over time. 
The kinematic routine finds these velocities by interpolating between grids of wind speed data. 
The dynamic routine calculates velocities using advection equations relating the parcel acceleration and the geopotential height of a given pressure level. 

\section{Ten Day Dataset}
Data from the Global Forecast System (GFS), a weather forecast model produced by the National Centers for Environmental Protection (NCEP), was used for both models.
The dataset chosen was a ten day forecast, starting at 12:00:00 on February 21st, 2017, with predictions at intervals of three hours.
Each file in the dataset contains atmospheric predictions for the beginning of a three-hour interval. 
The values of atmospheric variables are predicted at each point on a latitude-longitude grid spanning the globe, with a spacing between gridpoints of 0.25 degree.
Values are predicted for East-West and North-South wind speed components $u$ and $v$, as well as the geopotential height $Z_g$ of the 250 millibar pressure level.

\section{Linear Interpolation}
Both the kinematic and dynamic models require an interpolation scheme to produce values for atmospheric variables at positions between the gridded values provided by GFS. 
Linear interpolation is the standard choice for trajectory models \cite{bowman_input_2013}. 
For both models, linear interpolation was used in three dimensions (latitude, longitude, and time). 
In the kinematic model, $u$ and $v$ components of wind speed were interpolated to the current positions of the air parcels, while in the dynamic model, geopotential height was interpolated.

\section{Second-order Integration Scheme}
The numerical scheme chosen was a second-order Runge-Kutta method which has a long track record in trajectory modeling \cite{petterssen_weather_1940}.
The velocity at a given timestep is taken to be the average of the velocity at the initial position and the velocity at the first-guess position after one timestep.

The first guess position $\vec{P}' (t + \Delta t)$ is 
\begin{align}
\vec{P}' (t + \Delta t) = \vec{P}(t) + \vec{V} (\vec{P}, t) \Delta t
\end{align}

and the final position $\vec{P} (t + \Delta t)$ is
\begin{align}
\vec{P} (t + \Delta t) = \vec{P} (t) + \frac{1}{2} \left [ \vec{V} (\vec{P}, t) + \vec{V} (\vec{P'}, t + \Delta t) \right ] \Delta t
\end{align}

where $\vec{P}$ is a position vector with latitude and longitude components, and $\vec{V}$ a velocity vector with $u$ and $v$ wind speeds \cite{draxler_description_1997}.
This integration method is used by HYSPLIT and a number of other trajectory models, including FLEXPART, LAGRANTO, and STILT \cite{stein_noaas_2015} \cite{bowman_input_2013}. 
For trajectories calculated from interpolated gridded wind velocities, higher order integration schemes do not add precision \cite{draxler_description_1997}.  

\section{Constant Timestep}
The timestep for integration was three minutes, with the timestep throughout the trajectory. 
To save computation, HYSPLIT uses a dynamic timestep, varying from one minute to one hour, computed to satisfy

\begin{align}
U_{max} [\text{grid-units min}^{-1}] \Delta t [\text{min}] < 0.75 [\text{grid-units}] 
\end{align}

\cite{draxler_description_1997}. This ensures that the parcel does not blow past any grid squares during a single timestep, which maximizes the accuracy of the calculation. 
[Todo: Plot u and v along my trajectories to see if the $U_{max} \Delta t < 0.75$ relation is always satisfied. If it isn't, consider reducing the timestep. If it is satisfied, write that here.]

\section{Kinematic Equations}
At each timestep, after $u$ and $v$ speeds were interpolated and an average value found using the integration scheme, the kinematic model used two equations to solve for a parcel's displacement. 
Since GFS provides $u$ and $v$ values in meters per second, the equations convert from Cartesian to geographic coordinates. 
The $r$ value of a parcel is taken to be the radius of the Earth $R_E$ plus the parcel's geopotential height $Z_g$.

\begin{align}
r &= R_E + Z_g \\[2ex]
\frac{d \varphi}{dt} &= \frac{v}{r} \label{eq:uposition} \\
\frac{d \lambda}{dt} &= \frac{u}{r \cos{\varphi}} \label{eq:vposition}
\end{align}

\section{Dynamic Equations}
In the dynamic model, velocity at the next timestep was calculated using advection equations which incorporate the current geopotential height gradient and the previous timestep's $u$ and $v$ values.
The Coriolis parameter $f$ measures the effect of the Earth's rotation speed $\Omega$ at a given latitude $\varphi$.
Standard acceleration due to gravity is $g$. 

\begin{align}
f &= 2 \Omega \sin{\varphi} \\[2ex]
\frac{du}{dt} &= fv - \frac{g}{r \cos{\varphi}} \frac{\partial Z_g}{\partial \lambda} \label{eq:uvelocitygeo}\\
\frac{dv}{dt} &= -fu -\frac{g}{r} \frac{\partial Z_g}{\partial \varphi} \label{eq:vvelocitygeo}
\end{align}

Equations \ref{eq:uvelocitygeo} and \ref{eq:vvelocitygeo} are equations \ref{eq:uvelocity} and \ref{eq:vvelocity} transformed from Cartesian to geographic coordinates. 
After velocity at the next timestep is determined, the dynamic model also uses kinematic equations \ref{eq:uposition} and \ref{eq:vposition} to find the parcel position.

\section{Mean Trajectory and RMSE}
For an ensemble of parcels, variance among trajectories over time was measured by calculating the mean trajectory: the path of an imaginary parcel whose position at each timestep is the average of the parcels' positions.
At each timestep, the root-mean-square error (RMSE) is the square root of the average squared value of each particle's distance from the mean trajectory.

The mean trajectory was determined by finding the centroids of parcel positions at each timestep after converting trajectory latitudes and longitudes to Cartesian coordinates. 
NumPy's \texttt{arctan2(y,x)} is a two-argument arctangent function with a range of $(-\pi, \pi]$.

\begin{align}
x &= \cos \varphi \cos \lambda & \bar{x} &= \frac{x_1 + x_2 + \cdots + x_n}{n} \\
y &= \cos \varphi \sin \lambda & \bar{y} &= \frac{y_1 + y_2 + \cdots + y_n}{n} \\
z &= \sin \varphi & \bar{z} &= \frac{z_1 + z_2 + \cdots + z_n}{n} \\[2ex]
\bar{\lambda} &= \arctantwo{(\bar{y},\bar{x})} \\
\bar{\varphi} &= \arctantwo{(\bar{z}, \sqrt{\bar{x}^2 + \bar{y}^2})}
\end{align}

The distance $d$ between each parcel (with position $\varphi_i, \lambda_i$) and the mean parcel was calculated with the haversine formula

\begin{align}
\Delta \varphi_i &= | \varphi_i - \bar{\varphi}| \\
\Delta \lambda_i &= |\lambda_i - \bar{\lambda}| \\
a_i &= \sin^2 \left ( \frac{\Delta \varphi}{2} \right ) + \cos{\varphi_1}  \cos{\varphi_2} \sin^2 \left ( \frac{\Delta \lambda}{2} \right ) \\
c_i &= 2 \cdot \arctantwo{(\sqrt{a}, \sqrt{1 - a})} \\
d_i &= R_E \cdot c
\end{align}

which is accurate and well-conditioned for small angles \cite{sinnott_virtues_1984}. 
The RMSE at each timestep is calculated using the distance between each parcel and the mean parcel.

\begin{align}
\text{RMSE} = \sqrt{\frac{{d_1}^2 + {d_2}^2 + \cdots + {d_n}^2}{n}}
\end{align}
